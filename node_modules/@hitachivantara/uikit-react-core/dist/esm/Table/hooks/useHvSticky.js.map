{"version":3,"file":"useHvSticky.js","sources":["../../../../src/Table/hooks/useHvSticky.ts"],"sourcesContent":["import {\n  Hooks,\n  makePropGetter,\n  PropGetter,\n  TableCommonProps,\n  useGetLatest,\n} from \"react-table\";\nimport { theme } from \"@hitachivantara/uikit-styles\";\n\n// #region ##### TYPES #####\n\nexport interface UseHvTableStickyTableHeadProps extends TableCommonProps {\n  stickyHeader?: boolean;\n}\n\nexport type HvTableHeadPropGetter<D extends object> = PropGetter<\n  D,\n  UseHvTableStickyTableHeadProps\n>;\n\nexport type UseHvTableStickyTableOptions = {\n  stickyHeader?: boolean;\n  stickyColumns?: boolean;\n};\n\nexport interface UseHvTableStickyHooks<D extends object> {\n  getTableHeadProps: Array<HvTableHeadPropGetter<D>>;\n}\n\nexport interface UseHvTableStickyTableInstance<D extends object> {\n  getTableHeadProps: (\n    propGetter?: HvTableHeadPropGetter<D>,\n  ) => UseHvTableStickyTableHeadProps;\n\n  totalRight?: number;\n  hasStickyColumns?: boolean;\n}\n\n// props target: <table>\nexport interface UseHvTableStickyTableProps {\n  stickyHeader?: boolean;\n  stickyColumns?: boolean;\n}\n\n// props target: <table><thead><tr><th>\nexport interface UseHvTableStickyColumnProps {\n  stickyColumn?: boolean;\n  stickyColumnMostLeft?: boolean;\n  stickyColumnLeastRight?: boolean;\n}\n\n// props target: <table><tbody><tr><td>\nexport interface UseHvTableStickyCellProps {\n  stickyColumn?: boolean;\n  stickyColumnMostLeft?: boolean;\n  stickyColumnLeastRight?: boolean;\n}\n\nexport type UseHvTableSticky = (<D extends object = Record<string, unknown>>(\n  hooks: Hooks<D>,\n) => void) & { pluginName: string };\n\n// #endregion ##### TYPES #####\n\nconst isSticky = (value: any) => /left|right/i.test(value);\n\nconst getStickyValue = ({ sticky, parent }: any) => {\n  if (isSticky(sticky)) {\n    return sticky;\n  }\n\n  if (parent != null) {\n    // check if parent is sticky\n    sticky = getStickyValue(parent);\n    if (isSticky(sticky)) {\n      return sticky;\n    }\n\n    const { columns } = parent;\n    // check if any column in the same group is sticky\n    if (columns?.length > 0) {\n      sticky = columns?.find((col: any) => col.sticky != null)?.sticky;\n      if (isSticky(sticky)) {\n        return sticky;\n      }\n    }\n  }\n\n  return undefined;\n};\n\nconst updateColumnAndParent = (column: any, props: any) => {\n  Object.assign(column, props);\n\n  if (column.parent != null) {\n    updateColumnAndParent(column.parent, props);\n  }\n};\n\nconst visibleColumnsHook = (columns: any, { instance }: any) => {\n  const toTheLeft: any[] = [];\n  const toTheRight: any[] = [];\n  const others: any[] = [];\n\n  columns.forEach((column: any) => {\n    const sticky = getStickyValue(column)?.toLowerCase();\n\n    updateColumnAndParent(column, { sticky });\n\n    if (sticky === \"left\") {\n      toTheLeft.push(column);\n    } else if (sticky === \"right\") {\n      toTheRight.push(column);\n    } else {\n      others.push(column);\n    }\n  });\n\n  if (others.length > 0) {\n    const [firstNotSticky] = others;\n    updateColumnAndParent(firstNotSticky, { isFirstNotSticky: true });\n\n    const lastNotSticky = others[others.length - 1];\n    updateColumnAndParent(lastNotSticky, { isLastNotSticky: true });\n  }\n\n  const hasLeftSticky = toTheLeft.length > 0;\n  if (hasLeftSticky) {\n    const lastLeftSticky = toTheLeft[toTheLeft.length - 1];\n\n    updateColumnAndParent(lastLeftSticky, { isLastLeftSticky: true });\n  }\n\n  const hasRightSticky = toTheRight.length > 0;\n  if (hasRightSticky) {\n    const [firstRightSticky] = toTheRight;\n\n    updateColumnAndParent(firstRightSticky, { isFirstRightSticky: true });\n  }\n\n  instance.hasStickyColumns = hasLeftSticky || hasRightSticky;\n\n  return [...toTheLeft, ...others, ...toTheRight];\n};\n\nconst calculateHeaderWidthsToTheRight = (headers: any, right = 0) => {\n  if (!headers?.length) {\n    return;\n  }\n\n  for (let i = headers.length - 1; i !== -1; i -= 1) {\n    const header = headers[i];\n\n    header.totalRight = right;\n\n    const { headers: subHeaders } = header;\n    if (subHeaders?.length > 0) {\n      calculateHeaderWidthsToTheRight(subHeaders, right);\n    }\n\n    if (header.isVisible) {\n      right += header.totalWidth;\n    }\n  }\n};\n\nconst useInstanceHook = (instance: any) => {\n  calculateHeaderWidthsToTheRight(instance.headers);\n\n  const getInstance = useGetLatest(instance);\n  instance.getTableHeadProps = makePropGetter(\n    instance.getHooks().getTableHeadProps,\n    {\n      instance: getInstance(),\n    },\n  );\n};\n\nconst getRowProps = () => ({\n  style: {\n    display: \"flex\",\n    flex: \"1 0 auto\",\n  },\n});\n\nconst getCellProps = (header: any, isHeaderCell: boolean) => {\n  const props: UseHvTableStickyCellProps & { style: React.CSSProperties } = {\n    style: {\n      display: \"inline-flex\",\n      flex: `${header.totalWidth} ${header.totalMinWidth} auto`,\n      alignItems: isHeaderCell ? \"start\" : \"center\",\n      justifyContent: header.align,\n\n      width: `${header.totalWidth}px`,\n      minWidth: `${header.totalMinWidth}px`,\n      ...(isHeaderCell && { backgroundColor: theme.colors.atmo2 }),\n    },\n  };\n\n  if (header.sticky != null) {\n    props.stickyColumn = true;\n\n    const margin =\n      header.sticky === \"left\" ? header.totalLeft : header.totalRight;\n\n    // @ts-ignore\n    props.style[header.sticky] = `${margin}px`;\n\n    if (header.isLastLeftSticky) {\n      props.stickyColumnMostLeft = true;\n    }\n\n    if (header.isFirstRightSticky) {\n      props.stickyColumnLeastRight = true;\n    }\n  } else {\n    if (header.isFirstNotSticky) {\n      props.style.borderLeft = 0;\n    }\n\n    if (header.isLastNotSticky) {\n      props.style.borderRight = 0;\n    }\n  }\n\n  return props;\n};\n\n/*\n * STICKY POSITION MANAGEMENT\n *   <thead>: sticky if stickyHeader: true\n *   <tr>: never sticky\n *   <th>: sticky only if that particular column is sticky (left or right)\n */\n\n/*\n * We need to hide the last non sticky column right border, to avoid issues with double borders.\n *\n * This could be done with css, using the `:has()` selector:\n *  - \".not-sticky:has(+ .first-right-sticky)\": { border-right: 0 }\n *\n * Until the `:has()` selector is supported by modern browsers,\n * that at the moment is just a proposal https://developer.mozilla.org/en-US/docs/Web/CSS/:has,\n * we need to override the last not sticky column \"borderRight\" here.\n */\n\n// props target: <table>\nconst getTablePropsHook = (props: any, { instance }: any) => {\n  const nextProps: UseHvTableStickyTableProps = {\n    stickyHeader: instance.stickyHeader,\n    stickyColumns: instance.hasStickyColumns,\n  };\n\n  return [props, nextProps];\n};\n\n// props target: <table><thead>\nconst getTableHeadPropsHook = (props: any, { instance }: any) => {\n  const nextProps = {\n    stickyHeader: instance.stickyHeader,\n  };\n\n  return [props, nextProps];\n};\n\n// props target: <table><thead><tr>\nconst getHeaderGroupPropsHook = (props: any, { instance }: any) => {\n  const nextProps = instance.hasStickyColumns ? getRowProps() : {};\n\n  return [props, nextProps];\n};\n\n// props target: <table><thead><tr><th>\nconst getHeaderPropsHook = (props: any, { instance, column }: any) => {\n  const nextProps = instance.hasStickyColumns ? getCellProps(column, true) : {};\n\n  return [props, nextProps];\n};\n\n// props target: <table><tbody><tr>\nconst getRowPropsHook = (props: any, { instance }: any) => {\n  const nextProps = instance.hasStickyColumns ? getRowProps() : {};\n\n  return [props, nextProps];\n};\n\n// props target: <table><tbody><tr><td>\nconst getCellPropsHook = (props: any, { instance, cell }: any) => {\n  const nextProps: UseHvTableStickyCellProps = instance.hasStickyColumns\n    ? getCellProps(cell.column, false)\n    : {};\n\n  return [props, nextProps];\n};\n\nexport const useHvTableSticky: UseHvTableSticky = (hooks) => {\n  hooks.visibleColumns.push(visibleColumnsHook);\n  hooks.useInstance.push(useInstanceHook);\n\n  // props target: <table>\n  hooks.getTableProps.push(getTablePropsHook);\n  // props target: <table><thead>\n  hooks.getTableHeadProps = [getTableHeadPropsHook];\n  // props target: <table><thead><tr>\n  hooks.getHeaderGroupProps.push(getHeaderGroupPropsHook);\n  // props target: <table><thead><tr><th>\n  hooks.getHeaderProps.push(getHeaderPropsHook);\n  // props target: <table><tbody><tr>\n  hooks.getRowProps.push(getRowPropsHook);\n  // props target: <table><tbody><tr><td>\n  hooks.getCellProps.push(getCellPropsHook);\n};\n\nuseHvTableSticky.pluginName = \"useHvTableSticky\";\n"],"names":[],"mappings":"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"}